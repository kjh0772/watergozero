# Modbus RTU 가이드 (smart-server)

다른 프로젝트에서 동일한 Modbus 설정을 참고할 수 있도록, 현재 서버에 설정된 **연결 정보**, **코일(Coil) 주소**, **레지스터(Register) 주소**를 정리한 문서입니다.

---

## 1. 연결 설정

### 1.1 통신 방식

| 항목 | 값 |
|------|-----|
| 프로토콜 | Modbus RTU |
| 라이브러리 | `modbus-serial` (Node.js) |
| 연결 방식 | `connectRTUBuffered(port, options)` |

### 1.2 시리얼 파라미터

| 항목 | 값 | 비고 |
|------|-----|------|
| **Baud Rate** | 9600 | 고정 |
| **포트 (Linux)** | `/dev/ttyUSB0` (USB-RS485 동글) 또는 `/dev/serial1` (라즈베리 파이 내장 UART) | `index.js`에서 배열로 정의, 순서대로 재시도 |
| **타임아웃** | 2000 ms | `modbus.js`에서 설정 |
| **턴어라운드** | 20 ms (PLC), 8 ms (센서) | `setID()` 전환 후 대기 시간 |

### 1.3 포트 설정 위치

- **설정 파일**: `index.js`
- **초기화**: `modbus.js` → `initModbus(selectedPort)`
- **재연결**: 실패 시 `ports` 배열의 다음 포트로 5초 간격 재시도

```javascript
// index.js 예시
const ports = ['/dev/serial1', '/dev/ttyUSB0'];
setPorts(ports);
await initModbus(tryPort);
```

---

## 2. Slave ID (장치 주소)

| Slave ID | 용도 | 비고 |
|----------|------|------|
| **1** | PLC (환기/램프 제어, 코일·레지스터 읽기) | 코일 읽기/쓰기, 레지스터 읽기 |
| **2** | 온습도·CO2 센서 #1 | Holding/Input 레지스터 읽기 |
| **3** | 온습도·CO2 센서 #2 | Holding/Input 레지스터 읽기 |

- 같은 RS-485 버스에 PLC(1), 센서(2, 3)가 연결되어 있으며, 통신 시 `client.setID(slaveId)`로 장치를 선택합니다.

---

## 3. 코일(Coils) 주소 맵 — Slave ID 1 (PLC)

### 3.1 코일 읽기 (PLC 상태 수신)

| 항목 | 값 | 비고 |
|------|-----|------|
| **시작 주소** | 0 | |
| **길이** | 50 | |
| **실제 주소 범위** | 0 ~ 49 | |

- **호출 위치**: `index.js` 폴링 루프 → `readCoils(0, 50, 1)`
- **용도**: PLC 코일 상태 읽기 (예: rainSensor 등)

#### 읽은 코일 배열에서 사용하는 인덱스

| 배열 인덱스 | PLC 주소 | 용도 |
|-------------|----------|------|
| 0 | 0 | **rainSensor** (우천 센서) — vent 제어에서 사용 |

(필요 시 다른 인덱스도 동일한 방식으로 문서화 가능)

### 3.2 코일 쓰기 (PLC 제어)

| 항목 | 값 | 비고 |
|------|-----|------|
| **시작 주소** | 1032 | `baseAddress` |
| **쓰기 개수** | 16 | 한 번에 16개 코일 연속 쓰기 |
| **실제 주소 범위** | 1032 ~ 1047 | |

- **호출 위치**: `lib/modbus/writeRelay.ts` → `writeCoils(1032, coilArray, slaveId)`
- **배열**: `coilArray[0]` ~ `coilArray[15]`가 각각 주소 1032 ~ 1047에 대응

#### 코일 쓰기 주소 상세 (1032 ~ 1047) — 관수 시스템

| PLC 주소 | 배열 인덱스 | 용도 |
|----------|-------------|------|
| 1032 | 0 | P1 (펌프 1) |
| 1033 | 1 | P2 (펌프 2) |
| 1034 | 2 | P3 (펌프 3) |
| 1035 | 3 | P4 (펌프 4) |
| 1036 | 4 | 밸브 0 (구역 1) |
| 1037 | 5 | 밸브 1 (구역 2) |
| 1038 | 6 | 밸브 2 (구역 3) |
| 1039 | 7 | 밸브 3 (구역 4) |
| 1040 | 8 | 밸브 4 (구역 5) |
| 1041 | 9 | 밸브 5 (구역 6) |
| 1042 | 10 | 밸브 6 (구역 7) |
| 1043 | 11 | 밸브 7 (구역 8) |
| 1044 | 12 | 밸브 8 (구역 9) |
| 1045 | 13 | 밸브 9 (구역 10) |
| 1046 | 14 | 밸브 10 (구역 11) |
| 1047 | 15 | 밸브 11 (구역 12) |

### 3.3 API를 통한 단일 코일 제어

- **엔드포인트**: `POST /api/plc/coils/toggle`
- **PLC 주소 계산**: `plcAddress = 1000 + address` (클라이언트가 보낸 `address`는 0-based처럼 쓰이면 32 → 1032)

---

## 4. 레지스터(Registers) 주소 맵

### 4.1 PLC (Slave ID 1) — Holding Registers

| 항목 | 값 | 비고 |
|------|-----|------|
| **Function Code** | 3 (Read Holding Registers) | |
| **시작 주소** | 2000 | |
| **길이** | 20 | |
| **실제 주소 범위** | 2000 ~ 2019 | |

- **호출 위치**: `index.js` 폴링 루프 → `readRegisters(2000, 20, 1)`
- **용도**: PLC 홀딩 레지스터 값 읽기 (필요 시 각 레지스터 의미는 PLC 메뉴얼 기준으로 추가)

### 4.2 온습도·CO2 센서 (Slave ID 2, 3)

| 항목 | 값 | 비고 |
|------|-----|------|
| **Function Code** | 3 (Holding) 또는 4 (Input) | 장치에 따라 자동 탐색 |
| **시작 주소** | 0 또는 1 | FC4일 때 30001 표기 = 주소 0 |
| **길이** | 3 | 레지스터 3개 |
| **Slave ID** | 2, 3 | `index.js`에서 `sensorIds = [2, 3]` |

- **호출 위치**: `sensors/thx.js` → `readSensorData(slaveId)` (내부에서 FC3/FC4, addr 0/1 시도)

#### 레지스터 데이터 배치 (3레지스터)

| 레지스터 인덱스 | 의미 | 단위/비고 |
|-----------------|------|-----------|
| 0 | 습도 | 실제 값 = 레지스터 값 / 10 |
| 1 | 온도 | 부호 있는 16비트, 실제 값 = 레지스터 값 / 10 (예: -9.7℃ → 0xFF9F 등) |
| 2 | CO2 | ppm (정수) |

- **타임아웃**: 센서용 1200 ms (`sensors/thx.js`).
- **턴어라운드**: Slave 전환 후 8 ms 대기.

---

## 5. 폴링 순서 (참고)

1. `readCoils(0, 50, 1)` — PLC 코일
2. `readRegisters(2000, 20, 1)` — PLC 레지스터
3. `readSensorData(2)`, `readSensorData(3)` — 센서 (Slave 2, 3)
4. 환기 제어 로직 실행 후 `writeCoils(1032, coilArray, 1)` — 16개 코일 한 번에 쓰기

Slave 전환 시 턴어라운드(20 ms 또는 8 ms)를 두어 버스 안정화 후 다음 요청을 보냅니다.

---

## 6. 다른 프로젝트에서 쓸 때 체크리스트

- [ ] **포트**: Windows는 `COM3` 등, Linux는 `/dev/ttyUSB0` 등 환경에 맞게 변경
- [ ] **Baud**: 9600 유지 (PLC/센서와 동일해야 함)
- [ ] **Slave ID**: PLC=1, 센서=2,3 그대로 사용할지 여부 확인
- [ ] **코일 쓰기**: 1032부터 16개 = 1032~1047
- [ ] **코일 읽기**: 0부터 50개 (필요 구간만 사용 가능)
- [ ] **레지스터 읽기**: PLC 2000~2019, 센서는 FC3/FC4 + addr 0 또는 1, len 3
- [ ] **센서 데이터 해석**: 습도/온도/CO2 순서, 온도는 16비트 부호 있는 값으로 변환 후 /10

이 문서는 `smart-server` 코드베이스 기준으로 작성되었으며, 실제 PLC·센서 메뉴얼과 다를 수 있으면 장비 메뉴얼을 우선하세요.
